@using System.Text.Json
@using System.Text
@using AirQoon.Web.Services
@using AirQoon.Web.Models.Chat
@using Markdig
@using Microsoft.AspNetCore.Components
@inject NavigationManager Nav
@inject IChatOrchestrationService Chat
@inject IJSRuntime Js
@implements IAsyncDisposable

<div class="aq-chat">
    <div class="aq-chat-header">
        <div class="aq-chat-title">
            <strong>AirQoon Chat</strong>
            @if (!string.IsNullOrWhiteSpace(_tenantSlug))
            {
                <span class="aq-chat-tenant">@_tenantSlug</span>
            }
        </div>
        <div class="aq-chat-header-actions">
            <div class="aq-chat-session">Session: <code>@_sessionId</code></div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="ShowEndChatModal">Konuşmayı Bitir</button>
        </div>
    </div>

    <div class="aq-chat-messages">
        @foreach (var m in _messages)
        {
            <div class="aq-chat-row @(m.IsUser ? "aq-chat-row-user" : "aq-chat-row-assistant")">
                <div class="aq-chat-bubble @(m.IsUser ? "aq-chat-bubble-user" : "aq-chat-bubble-assistant")">
                    @if (m.IsUser)
                    {
                        <div class="aq-chat-text" style="white-space: pre-wrap;">@m.Text</div>
                    }
                    else
                    {
                        var parsed = ParseAssistantReply(m);
                        <div class="aq-md">
                            @((MarkupString)RenderMarkdown(parsed.MainText))

                            @if (!string.IsNullOrWhiteSpace(parsed.RagText))
                            {
                                if (parsed.RagCount <= 1)
                                {
                                    <div class="mt-2 aq-rag">
                                        @((MarkupString)RenderMarkdown(parsed.RagText))
                                    </div>
                                }
                                else
                                {
                                    var expanded = IsRagExpanded(m);
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="() => ToggleRag(m)">
                                            @(expanded ? "İlgili Analizleri Gizle" : "İlgili Analizleri Göster")
                                        </button>
                                    </div>

                                    @if (expanded)
                                    {
                                        <div class="mt-2 aq-rag">
                                            @((MarkupString)RenderMarkdown(parsed.RagText))
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="aq-chat-composer">
        <div class="aq-chat-inputs">
            <input class="form-control aq-chat-tenant-input" placeholder="Tenant (opsiyonel)" @bind="_tenantInput" />
            <input class="form-control aq-chat-message-input" placeholder="Mesaj..." @bind="_input" @bind:event="oninput" @onkeydown="OnKeyDown" />
            <button class="btn btn-primary aq-chat-send" @onclick="SendAsync" disabled="@_sending">Gönder</button>
        </div>

        @if (_lastCard is not null)
        {
            <div class="aq-chat-insight">
                <AirQualityCard Title="_lastCard.Title" Subtitle="_lastCard.Subtitle" Items="_lastCard.Items" />
            </div>
        }

        @if (_chart is not null)
        {
            <div class="aq-chat-insight" style="height: 240px;">
                <AirQualityChart Title="_chart.Title" Labels="_chart.Labels" Values="_chart.Values" />
            </div>
        }
    </div>
</div>

@if (_showEndChatModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Konuşmayı Bitir</h5>
                    <button type="button" class="btn-close" @onclick="CloseEndChatModal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Konuşma geçmişini indirmek ister misiniz?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @onclick="EndChatWithDownload">Evet, İndir</button>
                    <button class="btn btn-secondary" @onclick="EndChatWithoutDownload">Hayır, Sadece Bitir</button>
                    <button class="btn btn-outline-secondary" @onclick="CloseEndChatModal">İptal</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private const string SessionKey = "chat_sessionId";
    private const string LastActivityKey = "chat_lastActivityUtc";
    private const string MessagesKey = "chat_messages";
    private static readonly TimeSpan InactivityTimeout = TimeSpan.FromMinutes(30);

    private string _sessionId = string.Empty;
    private string _input = string.Empty;
    private bool _sending;
    private string? _tenantInput;
    private string? _tenantSlug;

    private bool _showEndChatModal;
    private System.Threading.Timer? _inactivityTimer;
    private DateTime _lastActivityUtc;

    private readonly Dictionary<long, bool> _ragExpandedByMessageTicks = new();

    private readonly List<ChatLine> _messages = new();

    private CardModel? _lastCard;
    private ChartModel? _chart;

    protected override async Task OnInitializedAsync()
    {
        await LoadSessionAsync();
        EnsureInactivityTimer();
        await PersistSessionAsync();
    }

    public async ValueTask DisposeAsync()
    {
        _inactivityTimer?.Dispose();
        _inactivityTimer = null;
        await Task.CompletedTask;
    }

    private async Task LoadSessionAsync()
    {
        try
        {
            var storedSession = await Js.InvokeAsync<string?>("airqoonSession.get", SessionKey);
            var storedLast = await Js.InvokeAsync<string?>("airqoonSession.get", LastActivityKey);
            var storedMessages = await Js.InvokeAsync<string?>("airqoonSession.get", MessagesKey);

            if (!string.IsNullOrWhiteSpace(storedSession))
            {
                _sessionId = storedSession;
            }

            if (!string.IsNullOrWhiteSpace(storedLast) && DateTime.TryParse(storedLast, out var lastUtc))
            {
                _lastActivityUtc = DateTime.SpecifyKind(lastUtc, DateTimeKind.Utc);
            }
            else
            {
                _lastActivityUtc = DateTime.UtcNow;
            }

            if (!string.IsNullOrWhiteSpace(storedMessages))
            {
                var list = JsonSerializer.Deserialize<List<ChatLine>>(storedMessages);
                if (list is not null && list.Count > 0)
                {
                    _messages.Clear();
                    _messages.AddRange(list);
                }
            }

            if (string.IsNullOrWhiteSpace(_sessionId))
            {
                _sessionId = Guid.NewGuid().ToString();
            }

            var inactiveFor = DateTime.UtcNow - _lastActivityUtc;
            if (inactiveFor >= InactivityTimeout)
            {
                await OnInactivityTimeoutAsync();
                return;
            }

            if (_messages.Count == 0)
            {
                _messages.Add(new ChatLine(false, "Merhaba! Tenant ve hava kalitesi sorgularınız için buradayım.", DateTime.UtcNow));
            }
        }
        catch
        {
            if (string.IsNullOrWhiteSpace(_sessionId))
            {
                _sessionId = Guid.NewGuid().ToString();
            }
        }
    }

    private void EnsureInactivityTimer()
    {
        _inactivityTimer?.Dispose();
        _inactivityTimer = new System.Threading.Timer(
            _ => _ = InvokeAsync(OnInactivityTimeoutAsync),
            null,
            InactivityTimeout,
            System.Threading.Timeout.InfiniteTimeSpan);
    }

    private void TouchActivity()
    {
        _lastActivityUtc = DateTime.UtcNow;
        EnsureInactivityTimer();
        _ = PersistSessionAsync();
    }

    private async Task PersistSessionAsync()
    {
        try
        {
            await Js.InvokeVoidAsync("airqoonSession.set", SessionKey, _sessionId);
            await Js.InvokeVoidAsync("airqoonSession.set", LastActivityKey, _lastActivityUtc.ToString("O"));
            await Js.InvokeVoidAsync("airqoonSession.set", MessagesKey, JsonSerializer.Serialize(_messages));
        }
        catch
        {
        }
    }

    private async Task ClearSessionAsync()
    {
        try
        {
            await Js.InvokeVoidAsync("airqoonSession.remove", SessionKey);
            await Js.InvokeVoidAsync("airqoonSession.remove", LastActivityKey);
            await Js.InvokeVoidAsync("airqoonSession.remove", MessagesKey);
        }
        catch
        {
        }
    }

    private async Task OnInactivityTimeoutAsync()
    {
        _inactivityTimer?.Dispose();
        _inactivityTimer = null;

        await ClearSessionAsync();

        _sessionId = Guid.NewGuid().ToString();
        _lastActivityUtc = DateTime.UtcNow;

        _messages.Clear();
        _messages.Add(new ChatLine(false, "⏱️ 30 dakika boyunca mesaj gönderilmediği için oturum sonlandırıldı.", DateTime.UtcNow));
        _messages.Add(new ChatLine(false, "Yeni bir konuşma başlatıldı. Tenant ve sorunu yazabilirsin.", DateTime.UtcNow));

        await PersistSessionAsync();
        EnsureInactivityTimer();
        StateHasChanged();
    }

    private void ShowEndChatModal()
    {
        _showEndChatModal = true;
    }

    private void CloseEndChatModal()
    {
        _showEndChatModal = false;
    }

    private async Task EndChatWithDownload()
    {
        await DownloadChatHistoryAsync();
        await EndChatSessionAsync(false);
        CloseEndChatModal();
    }

    private async Task EndChatWithoutDownload()
    {
        await EndChatSessionAsync(false);
        CloseEndChatModal();
    }

    private async Task EndChatSessionAsync(bool showDownloadPrompt)
    {
        _inactivityTimer?.Dispose();
        _inactivityTimer = null;

        await ClearSessionAsync();

        _sessionId = Guid.NewGuid().ToString();
        _lastActivityUtc = DateTime.UtcNow;

        _messages.Clear();
        _messages.Add(new ChatLine(false, "Yeni bir konuşma başlatıldı. Tenant ve sorunu yazabilirsin.", DateTime.UtcNow));
        await PersistSessionAsync();

        EnsureInactivityTimer();
    }

    private async Task DownloadChatHistoryAsync()
    {
        try
        {
            var sb = new StringBuilder();
            sb.AppendLine("=== AirQoon Chat Geçmişi ===");
            sb.AppendLine($"Session ID: {_sessionId}");
            sb.AppendLine($"Tarih: {DateTime.Now:dd.MM.yyyy HH:mm:ss}");
            sb.AppendLine();

            foreach (var message in _messages)
            {
                var sender = message.IsUser ? "Kullanıcı" : "Asistan";
                sb.AppendLine($"[{message.Timestamp.ToLocalTime():dd.MM.yyyy HH:mm:ss}] {sender}:");
                sb.AppendLine(message.Text);
                sb.AppendLine();
                sb.AppendLine("---");
                sb.AppendLine();
            }

            var shortId = _sessionId.Length <= 8 ? _sessionId : _sessionId[..8];
            var fileName = $"airqoon_chat_{shortId}_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
            await Js.InvokeVoidAsync("airqoonSession.downloadTextFile", fileName, sb.ToString());
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatLine(false, $"❌ Geçmiş indirilirken hata oluştu: {ex.Message}", DateTime.UtcNow));
        }
    }

    private async Task SendAsync()
    {
        TouchActivity();
        var text = _input?.Trim() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(text) || _sending)
        {
            return;
        }

        _sending = true;
        _messages.Add(new ChatLine(true, text, DateTime.UtcNow));
        _input = string.Empty;
        await PersistSessionAsync();

        try
        {
            var req = new ChatRequest
            {
                SessionId = _sessionId,
                Message = text,
                Domain = Nav.Uri,
                TenantSlug = string.IsNullOrWhiteSpace(_tenantInput) ? null : _tenantInput
            };

            var chat = await Chat.HandleMessageAsync(req, CancellationToken.None);
            if (chat is null)
            {
                _messages.Add(new ChatLine(false, "Yanıt alınamadı.", DateTime.UtcNow));
                return;
            }

            _sessionId = chat.SessionId;
            _tenantSlug = chat.TenantSlug;
            _messages.Add(new ChatLine(false, chat.Reply, DateTime.UtcNow));
            TouchActivity();
            await PersistSessionAsync();

            BuildUiHintsFromReply(chat);
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatLine(false, ex.Message, DateTime.UtcNow));
        }
        finally
        {
            _sending = false;
            await PersistSessionAsync();
        }
    }

    private void BuildUiHintsFromReply(ChatResponse chat)
    {
        _lastCard = null;
        _chart = null;

        if (chat.Intent == IntentType.AirQualityQuery)
        {
            var card = TryParseAirQualityCard(chat.Reply, _tenantSlug);
            if (card is not null)
            {
                _lastCard = card;
            }
        }

        if (chat.Intent == IntentType.StatisticalAnalysis || chat.Intent == IntentType.ComparisonAnalysis)
        {
            var chart = TryBuildSimpleChart(chat.Reply);
            if (chart is not null)
            {
                _chart = chart;
            }
        }
    }

    private static CardModel? TryParseAirQualityCard(string reply, string? tenantSlug)
    {
        // Very lightweight parsing
        // Example lines:
        // "akcansa için PM10-24h (2025-01-01 - 2025-01-09)"
        // "Ortalama: 68.07 µg/m³"
        // "Minimum: 8.74 µg/m³"
        // "Maksimum: 201.11 µg/m³"

        var lines = (reply ?? string.Empty).Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (lines.Length < 2)
        {
            return null;
        }

        var header = lines[0];
        var items = new List<(string Key, string Value)>();

        foreach (var l in lines.Skip(1))
        {
            var idx = l.IndexOf(':');
            if (idx > 0)
            {
                var k = l[..idx].Trim();
                var v = l[(idx + 1)..].Trim();
                items.Add((k, v));
            }
        }

        if (items.Count == 0)
        {
            return null;
        }

        return new CardModel
        {
            Title = string.IsNullOrWhiteSpace(tenantSlug) ? "Air Quality" : $"{tenantSlug}",
            Subtitle = header,
            Items = items
        };
    }

    private static ChartModel? TryBuildSimpleChart(string reply)
    {
        // Fallback chart: plot per-parameter averages from MCP text blocks
        // Extract occurrences like "### PM10-24h" then "- Ortalama: 75.33"

        var labels = new List<string>();
        var values = new List<double>();

        var lines = (reply ?? string.Empty).Split('\n');
        string? currentParam = null;

        foreach (var raw in lines)
        {
            var line = raw.Trim();
            if (line.StartsWith("### "))
            {
                currentParam = line[4..].Trim();
            }

            if (currentParam is not null && line.StartsWith("- Ortalama:"))
            {
                var v = line.Replace("- Ortalama:", string.Empty).Trim();
                var num = v.Split(' ', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault();
                if (double.TryParse(num, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var d))
                {
                    labels.Add(currentParam);
                    values.Add(d);
                }
                currentParam = null;
            }
        }

        if (labels.Count == 0)
        {
            return null;
        }

        return new ChartModel
        {
            Title = "Ortalama değerler",
            Labels = labels,
            Values = values
        };
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendAsync();
        }
    }

    private sealed record ChatLine(bool IsUser, string Text, DateTime Timestamp);

    private sealed record ParsedAssistantReply(string MainText, string? RagText, int RagCount);

    private static readonly string RagSeparator = "\n\n---\n\n## İlgili önceki analizler (RAG)\n\n";

    private ParsedAssistantReply ParseAssistantReply(ChatLine m)
    {
        var text = m.Text ?? string.Empty;
        var idx = text.IndexOf(RagSeparator, StringComparison.Ordinal);
        if (idx < 0)
        {
            return new ParsedAssistantReply(text, null, 0);
        }

        var main = text[..idx].Trim();
        var rag = text[(idx + RagSeparator.Length)..].Trim();
        var ragCount = TryParseRagCount(rag);
        return new ParsedAssistantReply(main, rag, ragCount);
    }

    private static int TryParseRagCount(string ragText)
    {
        if (string.IsNullOrWhiteSpace(ragText))
        {
            return 0;
        }

        // Example line: "**Bulunan Sonuç:** 3 adet"
        var match = System.Text.RegularExpressions.Regex.Match(ragText, "\\*\\*Bulunan\\s+Sonuç:\\*\\*\\s+(?<n>\\d+)");
        if (match.Success && int.TryParse(match.Groups["n"].Value, out var n))
        {
            return n;
        }

        // Fallback: count result headers like "### 1. Sonuç" in the markdown
        var headers = System.Text.RegularExpressions.Regex.Matches(ragText, "(?m)^###\\s+\\d+\\.\\s+Sonuç");
        if (headers.Count > 0)
        {
            return headers.Count;
        }

        return 0;
    }

    private bool IsRagExpanded(ChatLine m)
    {
        return _ragExpandedByMessageTicks.TryGetValue(m.Timestamp.Ticks, out var v) && v;
    }

    private void ToggleRag(ChatLine m)
    {
        var key = m.Timestamp.Ticks;
        _ragExpandedByMessageTicks[key] = !IsRagExpanded(m);
    }

    private static readonly MarkdownPipeline MarkdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private static string RenderMarkdown(string? markdown)
    {
        var text = markdown ?? string.Empty;
        return Markdig.Markdown.ToHtml(text, MarkdownPipeline);
    }

    private sealed class CardModel
    {
        public string Title { get; set; } = string.Empty;
        public string Subtitle { get; set; } = string.Empty;
        public IReadOnlyList<(string Key, string Value)> Items { get; set; } = Array.Empty<(string Key, string Value)>();
    }

    private sealed class ChartModel
    {
        public string Title { get; set; } = string.Empty;
        public IReadOnlyList<string> Labels { get; set; } = Array.Empty<string>();
        public IReadOnlyList<double> Values { get; set; } = Array.Empty<double>();
    }
}
