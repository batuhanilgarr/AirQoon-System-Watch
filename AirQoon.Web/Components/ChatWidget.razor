@using System.Text.Json
@using AirQoon.Web.Models.Chat
@inject NavigationManager Nav
@inject IHttpClientFactory HttpClientFactory

<div class="card" style="max-width: 720px;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <strong>AirQoon Chat</strong>
            @if (!string.IsNullOrWhiteSpace(_tenantSlug))
            {
                <span class="badge bg-secondary ms-2">@_tenantSlug</span>
            }
        </div>
        <div class="text-muted" style="font-size: 0.9rem;">Session: @_sessionId</div>
    </div>

    <div class="card-body" style="height: 420px; overflow:auto;">
        @foreach (var m in _messages)
        {
            <div class="mb-2">
                <div class="fw-bold">@(m.IsUser ? "Sen" : "Asistan")</div>
                <div style="white-space: pre-wrap;">@m.Text</div>
            </div>
        }
    </div>

    <div class="card-footer">
        <div class="row g-2">
            <div class="col-12 col-md-4">
                <input class="form-control" placeholder="Tenant (opsiyonel)" @bind="_tenantInput" />
            </div>
            <div class="col-12 col-md-8">
                <input class="form-control" placeholder="Mesaj..." @bind="_input" @bind:event="oninput" @onkeydown="OnKeyDown" />
            </div>
            <div class="col-12 d-flex justify-content-end">
                <button class="btn btn-primary" @onclick="SendAsync" disabled="@_sending">Gönder</button>
            </div>
        </div>

        @if (_lastCard is not null)
        {
            <div class="mt-3">
                <AirQualityCard Title="_lastCard.Title" Subtitle="_lastCard.Subtitle" Items="_lastCard.Items" />
            </div>
        }

        @if (_chart is not null)
        {
            <div class="mt-3" style="height: 240px;">
                <AirQualityChart Title="_chart.Title" Labels="_chart.Labels" Values="_chart.Values" />
            </div>
        }
    </div>
</div>

@code {
    private string _sessionId = Guid.NewGuid().ToString();
    private string _input = string.Empty;
    private bool _sending;
    private string? _tenantInput;
    private string? _tenantSlug;

    private readonly List<ChatLine> _messages = new();

    private CardModel? _lastCard;
    private ChartModel? _chart;

    private async Task SendAsync()
    {
        var text = _input?.Trim() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(text) || _sending)
        {
            return;
        }

        _sending = true;
        _messages.Add(new ChatLine(true, text));
        _input = string.Empty;

        try
        {
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(Nav.BaseUri);

            var req = new ChatRequest
            {
                SessionId = _sessionId,
                Message = text,
                Domain = Nav.Uri,
                TenantSlug = string.IsNullOrWhiteSpace(_tenantInput) ? null : _tenantInput
            };

            var resp = await client.PostAsJsonAsync("/api/chat", req);
            resp.EnsureSuccessStatusCode();

            var chat = await resp.Content.ReadFromJsonAsync<ChatResponse>();
            if (chat is null)
            {
                _messages.Add(new ChatLine(false, "Yanıt alınamadı."));
                return;
            }

            _sessionId = chat.SessionId;
            _tenantSlug = chat.TenantSlug;
            _messages.Add(new ChatLine(false, chat.Reply));

            BuildUiHintsFromReply(chat);
        }
        catch (Exception ex)
        {
            _messages.Add(new ChatLine(false, ex.Message));
        }
        finally
        {
            _sending = false;
        }
    }

    private void BuildUiHintsFromReply(ChatResponse chat)
    {
        _lastCard = null;
        _chart = null;

        if (chat.Intent == IntentType.AirQualityQuery)
        {
            var card = TryParseAirQualityCard(chat.Reply, _tenantSlug);
            if (card is not null)
            {
                _lastCard = card;
            }
        }

        if (chat.Intent == IntentType.StatisticalAnalysis || chat.Intent == IntentType.ComparisonAnalysis)
        {
            var chart = TryBuildSimpleChart(chat.Reply);
            if (chart is not null)
            {
                _chart = chart;
            }
        }
    }

    private static CardModel? TryParseAirQualityCard(string reply, string? tenantSlug)
    {
        // Very lightweight parsing
        // Example lines:
        // "akcansa için PM10-24h (2025-01-01 - 2025-01-09)"
        // "Ortalama: 68.07 µg/m³"
        // "Minimum: 8.74 µg/m³"
        // "Maksimum: 201.11 µg/m³"

        var lines = (reply ?? string.Empty).Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        if (lines.Length < 2)
        {
            return null;
        }

        var header = lines[0];
        var items = new List<(string Key, string Value)>();

        foreach (var l in lines.Skip(1))
        {
            var idx = l.IndexOf(':');
            if (idx > 0)
            {
                var k = l[..idx].Trim();
                var v = l[(idx + 1)..].Trim();
                items.Add((k, v));
            }
        }

        if (items.Count == 0)
        {
            return null;
        }

        return new CardModel
        {
            Title = string.IsNullOrWhiteSpace(tenantSlug) ? "Air Quality" : $"{tenantSlug}",
            Subtitle = header,
            Items = items
        };
    }

    private static ChartModel? TryBuildSimpleChart(string reply)
    {
        // Fallback chart: plot per-parameter averages from MCP text blocks
        // Extract occurrences like "### PM10-24h" then "- Ortalama: 75.33"

        var labels = new List<string>();
        var values = new List<double>();

        var lines = (reply ?? string.Empty).Split('\n');
        string? currentParam = null;

        foreach (var raw in lines)
        {
            var line = raw.Trim();
            if (line.StartsWith("### "))
            {
                currentParam = line[4..].Trim();
            }

            if (currentParam is not null && line.StartsWith("- Ortalama:"))
            {
                var v = line.Replace("- Ortalama:", string.Empty).Trim();
                var num = v.Split(' ', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault();
                if (double.TryParse(num, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var d))
                {
                    labels.Add(currentParam);
                    values.Add(d);
                }
                currentParam = null;
            }
        }

        if (labels.Count == 0)
        {
            return null;
        }

        return new ChartModel
        {
            Title = "Ortalama değerler",
            Labels = labels,
            Values = values
        };
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendAsync();
        }
    }

    private sealed record ChatLine(bool IsUser, string Text);

    private sealed class CardModel
    {
        public string Title { get; set; } = string.Empty;
        public string Subtitle { get; set; } = string.Empty;
        public IReadOnlyList<(string Key, string Value)> Items { get; set; } = Array.Empty<(string Key, string Value)>();
    }

    private sealed class ChartModel
    {
        public string Title { get; set; } = string.Empty;
        public IReadOnlyList<string> Labels { get; set; } = Array.Empty<string>();
        public IReadOnlyList<double> Values { get; set; } = Array.Empty<double>();
    }
}
